# Git最佳实践手册

## 前言

本手册旨在对前端项目多分支开发的过程中，产生的代码合并、分支使用等问题，提供最佳实践。由于个人能力有限，本手册内容定有尚不完善或错误的地方，请读者和作者联系后，共同完善手册内容。为今后各小组工作过程中更安全快捷的使用Git，做出微薄贡献。

## 基础命令

再进行最佳实践前，不得不对Git及日常使用的命令做一个简单的介绍，因为这些最佳实践，其实就是根据当前情况，当前环境所做出的这些简单命令的组合。

- git详解 : 直接贴地址 http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/;

- git clone src : 一切项目的开始，复制代码到本地。注意src即项目在gitlab/github的地址，最好使用后缀为.git的地址。原因不赘述；

- git pull : 获取远端代码到本地，若他人提交了同文件的代码，此举会自动Merging代码。合并代码产生的冲突问题，后面有最佳实践补充说明；

- git add .	: 常用的ADD方法，此举会将所有modified的文件注入到Git本地暂存区，用于提交代码。注意此处的“.”和空格都是必要的；

- git add A : A即All，所有正常状态的下的文件都会提交（add、delete、modified），故出现新增文件和删除文件时一定要使用此命令；

- git add src :	添加单个文件；

- git commit -m“commit note” : 标准的commit方式，-m后面是提交必须输入的注释；

- git commit -am“commit note” : 偷懒方式，git add + git commit -m 的结合体；

- git status : 查询当前分支状态，非常实用。随时观察分支各种修改、合并、新增、删除状态。整体提高代码安全性；

- git diff : 对比分支与远程的却别，会针对每个文件给出半视图化的对比列表。通过方向键控制上下，Q键退出；

- git stash : 暂存功能，非常实用。最佳实践中会详细说明；

- git stash pop : 将暂存的内容取出，默认取出最后塞入的内容，具体操作参数请百度；

- git stash list : 获取所有暂存的内容列表；

- git checkout branchName : 切换分支到[branchName]；

- git checkout -b branchName : 基于当前分支创建新分支；

- git branch : 查看本地分支列表；

- git branch -a : 查看远程及本地分支列表；

- git branch -D branchName : 删除本地分支；

- git push origin --delete branchName : 删除远程分支；

- git push -f --set-upstream origin branchName : 强制覆盖更新远程分支；

- git remote prune origin : 清空远程分支信息缓存；

- git merge branchName : 合并branchName代码到当前分支；

- git reset --hard 版本号 : 本地强制回退至某个commit版本号；

基础命令基本就这样，欢迎补充。对于此命令详细的解释和定义，请自行Google或查询专业的Git文档文献。

## 最佳实践

#### 1. 反讲结束后，新建开发分支

- 1.1 简介：迭代的反讲结束后，前端人员需要在master分支的基础上新建分支，进行本迭代的开发。

- 1.2 重难点: 新建本地分支后，如何提交至远程。分支命名规范。

- 1.3 最佳实践
	- 进入master分支，git pull 获取最新代码。
	- git status，查询分支状态，保证当前环境无任何需要提交的代码或任何状态的文件。
	- git checkout -b branchName，基于master分支在本地创建新分支。此处需要注意，branchName命名须遵守规范，前半部分为英文构成的工作内容（如：netPools、headhunter），后半部分为当前年月（如：1506、1602）。组合后为netPools1506、headhunter1602。即可清晰标明为15年6月的网络人才库迭代和16年2月的猎头推荐迭代。
	- 新建后，会自动切换至新建的分支，执行第一次push，git push --set-upstream origin branchName，将分支提交至远程。

#### 2. 开发过程中每天需要Merge主干（master）代码

- 2.1 简介：由于招聘分为若干小组同时进行开发工作，所以为了防止当前上线分支（占用master的小组）与当前开发的分支中，存在冲突代码，故要求开发过程中，各小组负责人需要每天merge主干代码。以保证及早发现冲突问题，及早解决冲突问题。

- 2.2 重难点: 如何才是真正的merge！如何解决处理解决冲突代码

- 2.3 最佳实践
	- 保证当前分支代码干净后（无修改，全更新），切换至master主干。
	- 执行git pull，获取主干最新代码至本地。
	- 切换回开发的分支，执行git merge master，合并至开发分支。
	- 观察合并后列出的结果，查看是否未能自动merge的文件。注意CONFILCT关键字，存在即表明有冲突。或执行git status查看状态，存在both modified 也表明存在冲突。
	- 根据显示的路径进入存在未解决冲突的文件，Git会将冲突用会这组 >>>> ==== <<<< 符号进行分割。====分割了相互冲突的代码，解决冲突后，即可删除这组符号。
	- 解决所有冲突后，git status 检查所有both modified 是否修改，也可全局检索>>>>这些仅有冲突会使用的标记符号。
	- 确认无误或并无冲突，执行git push 提交代码至开发分支，并通知同组成员及时更新代码。

#### 3. 主干被占用情况下，有联调或测试需求

- 3.1 简介：由于招聘分为若干开发小组，各个小组间在开发阶段都是在各自的分支上进行开发的，仅在快要进入测试阶段时，才允许使用主干分支，但总有一些情况下，若干小组工作时间重叠，导致主干被占用。此时为了联调和测试方便，我们CI提供了固定IP的dev-1和dev-2分支，用于解决此类问题。

- 3.2 重难点: 如何正确使用dev分支，如何保证代码正确合并到dev分支。

- 3.3 最佳实践
	- 首先确定当前开发分支所有代码已经获取到本地。
	- 执行 git merge master 保持与主干代码的同步。若出现冲突请详见第二个最佳实践。
	- 接下来的步骤需要谨慎，切不可随意操作，可操作的分支仅为dev-1&dev-2。
	- 以dev-1为例，在本分支执行git branch -D dev-1 删除本地的dev-1分支（注意一定要保证所删除的分支无他人使用）。
	- 在本分支创建新dev-1分支git checkout -b dev-1。此举剔除了原dev-1分支残留的代码可能造成冲突的问题，增加代码安全性。
	- Git自动切换至新的dev-1分支，执行git push -f --set-upstream origin dev-1，强制覆盖提交至远程dev-1分支。

#### 4. 定期清理老旧分支

- 4.1 简介：在不断的开发过程中，会有越来越多的新分支被创建，同样也应该清理1年半年以上的老旧分支。便于管理和维护我们的项目。

- 4.2 重难点: 如何删干净远程分支，如何清理缓存信息。

- 4.3 最佳实践
	- 首先通过 git branch -a 查看本地和远程所有分支，确定需要删除的分支名称。
	- 执行 git branch -D branchName 在本地删除此分支。
	- 执行 git push origin --delete branchName 在远程删除此分支。
	- 再次使用 git branch -a 查看是否删除干净，一般会发现还存在该分支名称。
	- 使用 git remote prune origin 删除分支信息缓存。再次查看分支后，被删除的分支信息就不会再残留了。

#### 5. 分支代码回退版本（Beta）

- 5.1 简介：提交了错误的代码，最好的方式是改正后重新提交，但如果量比较大，涉及面比较广，就需要通过回退版本来恢复版本。

- 5.2 重难点: 回退至固定提交的commit。该分支其他开发成员如何处理分支。

- 5.3 最佳实践
	- 首先回退版本的方法为git reset --hard 版本号，之后提交代码。
	- 同分支的其他开发人员，首先需要git pull 获取分支最新代码，并git status 查看是否有回退后产生的commit信息。
	- 若存在，找到强制回退的版本号，在本地执行git reset --hard 版本号。
	- 再次git status 查看当前分支状态，确认是否还会有会退前的commit信息。
	- 需要注意的是，当产生回退时，所有参与此分支或会使用此分支的开发人员都需要进行版本查看和commit回退，以防止后续会将会退后的代码，再次别新的commit携带提交至远程。造成代码安全问题。
	- 上述遇到的情况很少，能不会退最好不这样，尤其是在hotfix分支，涉及面太广，安全性很差，需要所有开发人员配合修正，还需要负责人再三确认hotfix没有被回退前的代码污染。


## 后记

由于这些最佳实践是根据招聘前端团队现有的部分问题整理书写的，必然会存在许多狭隘的观点和论证，但对于招聘前端团队的日常使用时非常准确合适的，同时作者也希望，后续能够补充更多非特殊化的最佳实践，为更多团队和前端工程师提供帮助。


